rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is part of a 2-party document (match or chat)
    function isParticipant(doc) {
      return request.auth.uid in doc.data.userIds;
    }

    match /config/{docId} {
      allow read: if request.auth != null;
    }
    
    match /confidentialDocuments/{docId} {
      allow read: if request.auth != null &&
                     get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.ndaAccepted == true;
      allow write: if false;
    }

    // ===================================================================
    // START: THE FIX FOR "FAILED TO LOAD MEMBERS"
    // This rule now allows any authenticated user to read profiles,
    // but only allows a user to write to their own profile.
    // ===================================================================
    match /userProfiles/{userId} {
      // Allow any authenticated user to read all profiles (needed for find-cofounder page).
      allow read: if request.auth != null;

      // Only allow a user to create, update, or delete their own profile.
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    // ===================================================================
    // END: THE FIX
    // ===================================================================

    match /projects/{projectId} {
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.ownerId
        && request.resource.data.name is string && request.resource.data.name.size() > 0
        && request.resource.data.description is string
        && request.resource.data.stage is string
        && request.resource.data.isPrivate is bool
        && request.resource.data.milestones is string
        && request.resource.data.fundingStage is string
        && request.resource.data.progress == 0
        && request.resource.data.documents is list && request.resource.data.documents.size() == 0
        && request.resource.data.tags is list
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time;

      allow read: if request.auth != null && (
        resource.data.isPrivate == false ||
        request.auth.uid == resource.data.ownerId
      );

      allow update: if request.auth != null
        && request.auth.uid == resource.data.ownerId
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt == request.time;

      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;

      match /teamMembers/{teamMemberId} {
        function isProjectOwner() {
          return request.auth.uid == get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId;
        }
        function isProjectPublic() {
          return get(/databases/$(database)/documents/projects/$(projectId)).data.isPrivate == false;
        }
        function isTeamMember() {
          return exists(/databases/$(database)/documents/projects/$(projectId)/teamMembers/$(request.auth.uid));
        }

        allow create: if request.auth != null
          && isProjectOwner()
          && request.resource.data.userId == teamMemberId
          && request.resource.data.userId is string
          && request.resource.data.displayName is string
          && request.resource.data.role is string;

        allow read: if request.auth != null && (
          isProjectPublic() ||
          isProjectOwner() ||
          isTeamMember()
        );

        allow update: if request.auth != null
          && isProjectOwner()
          && request.resource.data.userId == resource.data.userId
          && request.resource.data.displayName is string
          && request.resource.data.role is string;

        allow delete: if request.auth != null && (
          isProjectOwner() ||
          request.auth.uid == teamMemberId
        );
      }
    }

    match /connection_requests/{requestId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.senderId
        && 'receiverId' in request.resource.data
        && request.resource.data.status == 'pending'
        && request.resource.data.createdAt == request.time;
      allow update: if request.auth != null
        && request.auth.uid == resource.data.receiverId
        && request.resource.data.status in ['accepted', 'declined']
        && request.resource.data.senderId == resource.data.senderId
        && request.resource.data.receiverId == resource.data.receiverId
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.updatedAt == request.time;
      allow delete: if request.auth != null && (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
    }

    match /matches/{matchId} {
      allow read: if request.auth != null && isParticipant(resource);
      allow delete: if request.auth != null && isParticipant(resource);
      allow create, update: if false;
    }

    match /chats/{chatId} {
      allow read, write: if request.auth != null && isParticipant(resource);
      match /messages/{messageId} {
        allow read: if request.auth != null && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
        allow create: if request.auth != null
          && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)))
          && request.auth.uid == request.resource.data.senderId
          && 'text' in request.resource.data
          && request.resource.data.createdAt == request.time;
        allow update, delete: if false;
      }
    }

    match /projectStages/{stageId} {
      allow read: if request.auth != null;
    }
    match /fundingStage/{docId} {
      allow read: if request.auth != null;
    }
    match /mvpStatus/{docId} {
      allow read: if request.auth != null;
    }
    match /milestones/{docId} {
      allow read: if request.auth != null;
    }
  }
}
